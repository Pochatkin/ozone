#!/usr/bin/env bash

# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# The name of the script being executed.
OZONE_SHELL_EXECNAME="ozone"
MYNAME="${BASH_SOURCE-$0}"
bin=$(cd -P -- "$(dirname -- "${MYNAME}")" >/dev/null && pwd -P)
JVM_PID="$$"

## @description  build up the ozone command's usage text.
## @audience     public
## @stability    stable
## @replaceable  no
function ozone_usage
{
  ozone_add_subcommand "s3" client "command line interface for s3 related operations"

  ozone_generate_usage "${OZONE_SHELL_EXECNAME}" false
}

## @description  Default command handler for ozone command
## @audience     public
## @stability    stable
## @replaceable  no
## @param        CLI arguments
function ozonecmd_case
{
  subcmd=$1
  shift

  ozone_default_log4j="${OZONE_CONF_DIR}/log4j.properties"
  ozone_shell_log4j="${OZONE_CONF_DIR}/ozone-shell-log4j.properties"
  if [ ! -f "${ozone_shell_log4j}" ]; then
    ozone_shell_log4j=${ozone_default_log4j}
  fi
  # Add JVM parameter (org.apache.ratis.thirdparty.io.netty.allocator.useCacheForAllThreads=false)
  # for disabling netty PooledByteBufAllocator thread caches for non-netty threads.
  # This parameter significantly reduces GC pressure for Datanode.
  # Corresponding Ratis issue https://issues.apache.org/jira/browse/RATIS-534.
  # TODO: Fix the problem related to netty resource leak detector throwing
  # exception as mentioned in HDDS-3812
  RATIS_OPTS="-Dorg.apache.ratis.thirdparty.io.netty.allocator.useCacheForAllThreads=false ${RATIS_OPTS}"
  RATIS_OPTS="-Dorg.apache.ratis.thirdparty.io.netty.leakDetection.level=disabled ${RATIS_OPTS}"

  case ${subcmd} in
    s3)
      OZONE_CLASSNAME=org.apache.hadoop.ozone.shell.s3.S3Shell
      OZONE_RUN_ARTIFACT_NAME="ozone-tools"
    ;;
    *)
      OZONE_CLASSNAME="${subcmd}"
      if ! ozone_validate_classname "${OZONE_CLASSNAME}"; then
        ozone_exit_with_usage 1
      fi
    ;;
  esac
}

# load functions
for dir in "${OZONE_LIBEXEC_DIR}" "${OZONE_HOME}/libexec" "${HADOOP_LIBEXEC_DIR}" "${HADOOP_HOME}/libexec" "${bin}/../libexec"; do
  if [[ -e "${dir}/ozone-functions.sh" ]]; then
    . "${dir}/ozone-functions.sh"
    if declare -F ozone_bootstrap >& /dev/null; then
      break
    fi
  fi
done

if ! declare -F ozone_bootstrap >& /dev/null; then
  echo "ERROR: Cannot find ozone-functions.sh." 2>&1
  exit 1
fi

ozone_bootstrap
. "${OZONE_LIBEXEC_DIR}/ozone-config.sh"

# now that we have support code, let's abs MYNAME so we can use it later
MYNAME=$(ozone_abs "${MYNAME}")

if [[ $# = 0 ]]; then
  ozone_exit_with_usage 1
fi

OZONE_SUBCMD=$1
shift


if ozone_need_reexec ozone "${OZONE_SUBCMD}"; then
  ozone_uservar_su ozone "${OZONE_SUBCMD}" \
    "${MYNAME}" \
    "--reexec" \
    "${OZONE_USER_PARAMS[@]}"
  exit $?
fi

ozone_verify_user_perm "${OZONE_SHELL_EXECNAME}" "${OZONE_SUBCMD}"

OZONE_SUBCMD_ARGS=("$@")

if declare -f ozone_subcommand_"${OZONE_SUBCMD}" >/dev/null 2>&1; then
  ozone_debug "Calling dynamically: ozone_subcommand_${OZONE_SUBCMD} ${OZONE_SUBCMD_ARGS[*]}"
  "ozone_subcommand_${OZONE_SUBCMD}" "${OZONE_SUBCMD_ARGS[@]}"
else
  ozonecmd_case "${OZONE_SUBCMD}" "${OZONE_SUBCMD_ARGS[@]}"
fi

ozone_assemble_classpath

ozone_add_client_opts

if [[ ${OZONE_WORKER_MODE} = true ]]; then
  ozone_worker_mode_execute "${OZONE_HOME}/bin/ozone-s3" "${OZONE_USER_PARAMS[@]}"
  exit $?
fi

ozone_subcommand_opts "${OZONE_SHELL_EXECNAME}" "${OZONE_SUBCMD}"

ozone_add_default_gc_opts

# everything is in globals at this point, so call the generic handler
ozone_generic_java_subcmd_handler
